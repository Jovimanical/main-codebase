# -*- coding: utf-8 -*-
# Generated by Django 1.11.7 on 2022-01-15 08:56
from __future__ import unicode_literals

from django.db import migrations


class Migration(migrations.Migration):

    dependencies = [
        ("external", "0021_auto_20210707_0846"),
    ]

    operations = [
        migrations.RunSQL(
            """
            create materialized view combined_tutor_data as
            	select 
            		A.id,

            	cast(jsonb_build_object(
            		'joined_description',string_agg(distinct UP.tutor_description || ' ' || UP.description, ','),
            		'education_description',string_agg(distinct E.school || ' ' || E.course, ','),
            		'work_description',string_agg(distinct W.name || ' '|| W.role,','),
            		'tutorskill_description',string_agg(distinct T.heading || ' ' || T.description ||' '||S.name,',')
            	) as TEXT) as "combined",
            	A.data_dump,
            		cast (jsonb_agg(distinct jsonb_build_object('id',L.id, 'state',L.state,'vicinity',L.vicinity)) as TEXT)  as "loc",
            		string_agg(distinct P.number,',') as "phone_numbers",
            			jsonb_agg(distinct
            			jsonb_build_object('id',T.id, 'skill',S.name,'heading',T.heading,'price',T.price,'status',T.status)
            		) AS "skills",
            		jsonb_agg(distinct L) as location,

            		jsonb_agg(distinct
            			jsonb_build_object('name',W.name,'role',W.role)
            		) AS "work_experiences",
            		jsonb_agg(distinct
            			jsonb_build_object('school',E.school,'course',E.course,'degree',E.degree)
            		) AS "educations"

            	from auth_user A left join users_userprofile UP on UP.user_id = A.id
            	left  join users_phonenumbers P on P.owner_id = A.id 
            	left  join users_location L on L.user_id = A.id
            	left join tutors_educations E on E.tutor_id = A.id
            	left join tutor_work_experiences W on W.tutor_id = A.id
            	left join skills_tutorskill T on T.tutor_id = A.id
            	left join skills_skill S on S.id = T.skill_id
            	where UP.application_status = 3 and T.status != 4 and P.primary and P.verified
            	group by A.id with no data;
            """,
            """
                DROP MATERIALIZED VIEW IF EXISTS combined_tutor_data;
            """,
        ),
        migrations.RunSQL(
            """
            REFRESH MATERIALIZED VIEW combined_tutor_data;
            """,
            """
            REFRESH MATERIALIZED VIEW combined_tutor_data;
            """,
        ),
        migrations.RunSQL(
            """
            CREATE UNIQUE INDEX idx_combined_tutor_data_id ON combined_tutor_data (id);
            """,
            """
            DROP INDEX IF EXISTS idx_combined_tutor_data_id
            """,
        ),
    ]
